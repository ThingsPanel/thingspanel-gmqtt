# 下行主题转换变更需求

## 一、数据库变更

**表名：** `device_topic_mappings`

**新增字段：**
- `data_identifier` VARCHAR(255) NULL
  - 说明：数据标识符，用于匹配命令 payload 中的 `method` 字段
  - 约束：非必填字段，允许为空

---

## 二、功能变更

### 2.1 适用范围

仅针对**下行命令主题**：`devices/command/{device_number}/+`

### 2.2 命令 Payload 结构

平台下发命令的 payload 格式：

```json
{
  "method": "Restart",
  "params": {
    "delay": 5,
    "mode": "safe"
  }
}
```

其中 `method` 字段用于匹配映射配置中的 `data_identifier`。

---

## 三、匹配逻辑

### 3.1 匹配流程

当平台发布到 `devices/command/{device_number}/+` 主题时，按以下步骤匹配：

1. **主题匹配**：遍历设备的下行映射配置，匹配目标主题 `devices/command/{device_number}/+`
2. **标识符匹配**：
   - 如果 `data_identifier` **不为空**：
     - 解析 payload 中的 `method` 字段
     - 若 `method == data_identifier`：**立即匹配成功，转发消息，并将 payload 精简为原 payload 的 `params` 值**（无 `params` 则转发空对象 `{}`）
     - 若 `method != data_identifier`：**继续匹配下一个配置**
   - 如果 `data_identifier` **为空或 NULL**：
     - **暂存该配置**（作为兜底选项）
     - **继续匹配下一个配置**
3. **兜底规则**：
   - 如果所有配置都匹配完成，且没有找到 `data_identifier` 匹配成功的配置
   - 则使用第一个 `data_identifier` 为空的配置进行转发（payload 保持原样）

---

## 四、示例场景

### 场景 1：方法匹配成功（payload 精简为 params）

**配置：**
- 映射1：`devices/command/{device_number}/+` → `wled/{device_number}/cmd/+`，`data_identifier = "Restart"`
- 映射2：`devices/command/{device_number}/+` → `wled/{device_number}/cmd/+`，`data_identifier = "Reset"`

**消息：**
- 主题：`devices/command/12345/msg001`
- Payload：`{"method": "Restart", "params": {"delay": 5, "mode": "safe"}}`

**结果：** 命中映射1，转发到 `wled/12345/cmd/msg001`，转发 payload 为 `{"delay":5,"mode":"safe"}`（仅 params 部分）

---

### 场景 2：方法未匹配，走兜底（payload 保持原样）

**配置：**
- 映射1：`devices/command/{device_number}/+` → `wled/{device_number}/cmd/+`，`data_identifier = "Restart"`
- 映射2：`devices/command/{device_number}/+` → `default/{device_number}/cmd/+`，`data_identifier = NULL`

**消息：**
- 主题：`devices/command/12345/msg001`
- Payload：`{"method": "UnknownMethod", "params": {"delay": 3}}`

**结果：** 映射1未命中，使用兜底映射2，转发到 `default/12345/cmd/msg001`，payload 保持原样

---

## 五、实现要点

1. **Payload 解析**：需要解析 JSON payload，提取 `method` 和 `params` 字段
2. **错误处理**：如果 payload 非 JSON 或缺少 `method`，则跳过 `data_identifier` 匹配，仅按主题匹配；`params` 缺失时视为 `{}` 参与精简
3. **转发内容**：当 `data_identifier` 匹配成功时，转发 payload 仅为原 payload 的 `params` 值；兜底配置则转发原始 payload

---

## 六、影响范围

- **代码文件**：
  - `plugin/thingspanel/topicmap_types.go`：添加 `DataIdentifier` 字段
  - `plugin/thingspanel/topicmap_service.go`：修改 `ResolveDownSource` 方法，增加 payload 解析和匹配逻辑
  - `plugin/thingspanel/hooks.go`：确保下行转发时传递完整的 payload

- **数据库**：需要执行 ALTER TABLE 语句添加新字段
