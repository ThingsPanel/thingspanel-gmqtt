# ThingsPanel-GMQTT 项目目录结构分析

## 项目概述

ThingsPanel-GMQTT 是一个基于 Gmqtt 的 MQTT Broker 实现，使用 Go 语言开发。这是一个功能完整的 MQTT 服务器，支持 MQTT v3.1.1 和 v5.0 协议，提供了插件化架构、持久化存储、集群支持等企业级特性。

## 目录结构

```
thingspanel-gmqtt/
├── cmd/                          # 可执行程序入口
│   ├── gmqctl/                   # MQTT 控制命令行工具
│   │   ├── command/              # 命令实现
│   │   │   └── gen-plugin/       # 插件生成工具
│   │   └── main.go
│   └── gmqttd/                   # MQTT Broker 守护进程
│       ├── certs/                # TLS/SSL 证书文件
│       ├── command/              # 服务器命令(start, reload等)
│       ├── default_config.yml    # 默认配置文件
│       ├── thingspanel.yml       # ThingsPanel 配置文件
│       └── main.go
│
├── config/                       # 配置管理模块
│   ├── api.go                    # API 配置
│   ├── config.go                 # 配置解析
│   ├── mqtt.go                   # MQTT 配置
│   ├── persistence.go            # 持久化配置
│   └── testdata/                 # 测试配置文件
│
├── persistence/                  # 持久化存储层
│   ├── encoding/                 # 数据编码(binary, redis)
│   ├── queue/                    # 消息队列
│   │   ├── mem/                  # 内存队列实现
│   │   ├── redis/                # Redis 队列实现
│   │   └── test/                 # 测试套件
│   ├── session/                  # 会话持久化
│   │   ├── mem/                  # 内存会话存储
│   │   ├── redis/                # Redis 会话存储
│   │   └── test/                 # 测试套件
│   ├── subscription/             # 订阅持久化
│   │   ├── mem/                  # 内存订阅存储(Trie树)
│   │   ├── redis/                # Redis 订阅存储
│   │   └── test/                 # 测试套件
│   └── unack/                    # 未确认消息持久化
│       ├── mem/                  # 内存存储
│       ├── redis/                # Redis 存储
│       └── test/                 # 测试套件
│
├── pkg/                          # 公共工具包
│   ├── bitmap/                   # 位图实现
│   ├── codes/                    # MQTT 错误码定义
│   ├── packets/                  # MQTT 协议包解析
│   └── pidfile/                  # PID 文件管理
│
├── plugin/                       # 插件系统
│   ├── admin/                    # 管理插件(gRPC/REST API)
│   │   ├── protos/               # Protobuf 定义
│   │   └── swagger/              # API 文档
│   ├── auth/                     # 认证插件
│   │   ├── protos/               # Protobuf 定义
│   │   ├── swagger/              # API 文档
│   │   └── testdata/             # 测试数据
│   ├── federation/               # 集群联邦插件
│   │   ├── examples/             # 集群配置示例
│   │   ├── protos/               # Protobuf 定义
│   │   └── swagger/              # API 文档
│   ├── prometheus/               # Prometheus 监控插件
│   └── thingspanel/              # ThingsPanel 集成插件
│       └── util/                 # 工具函数
│
├── retained/                     # 保留消息管理
│   └── trie/                     # Trie 树实现
│
├── server/                       # 核心服务器实现
│   ├── client.go                 # 客户端连接管理
│   ├── hooks.go                  # 钩子系统
│   ├── plugin.go                 # 插件管理
│   ├── server.go                 # 服务器主逻辑
│   ├── service.go                # 服务接口
│   └── testdata/                 # 测试证书和配置
│
├── topicalias/                   # Topic 别名管理
│   └── fifo/                     # FIFO 实现
│
├── script/                       # 脚本工具
├── docs/                         # 文档目录
│
├── message.go                    # 消息定义
├── session.go                    # 会话定义
├── subscription.go               # 订阅定义
├── plugin_generate.go            # 插件生成脚本
├── plugin_imports.yml            # 插件导入配置
├── go.mod                        # Go 模块定义
├── Makefile                      # 构建脚本
├── Dockerfile                    # Docker 镜像构建
└── README.md                     # 项目说明文档

```

## 核心模块说明

### 1. cmd/ - 可执行程序
- **gmqttd**: MQTT Broker 主程序，提供 TCP、WebSocket 连接支持
- **gmqctl**: 命令行管理工具，用于插件生成等操作

### 2. config/ - 配置管理
统一管理 MQTT、API、持久化等各类配置，支持 YAML 格式配置文件

### 3. persistence/ - 持久化层
采用接口抽象设计，支持内存和 Redis 两种存储后端：
- **queue**: 消息队列持久化
- **session**: 会话数据持久化
- **subscription**: 订阅关系持久化
- **unack**: 未确认消息(QoS 1/2)持久化

### 4. pkg/ - 基础包
- **packets**: MQTT 协议包的编解码实现
- **codes**: MQTT 错误码和原因码定义
- **bitmap**: 用于 Packet ID 管理的位图
- **pidfile**: 进程 PID 文件管理

### 5. plugin/ - 插件系统
采用插件化架构，核心插件包括：
- **admin**: 提供 gRPC 和 REST API 管理接口
- **auth**: 用户名/密码认证
- **federation**: 集群联邦支持(实验性)
- **prometheus**: Prometheus 监控指标
- **thingspanel**: ThingsPanel IoT 平台集成

### 6. server/ - 核心服务
- 客户端连接管理
- Hook 钩子系统(OnConnect, OnPublish, OnSubscribe 等)
- 插件加载和管理
- 消息发布订阅核心逻辑

### 7. retained/ - 保留消息
使用 Trie 树实现高效的 Topic 匹配和保留消息存储

### 8. topicalias/ - Topic 别名
实现 MQTT v5.0 的 Topic 别名功能

## 技术特点

1. **插件化架构**: 通过 Hook 机制实现功能扩展
2. **双存储支持**: 内存(高性能)和 Redis(持久化)
3. **协议完整**: 支持 MQTT v3.1.1 和 v5.0
4. **生产就绪**: 支持 TLS/SSL、WebSocket、监控、API 管理
5. **集群支持**: 通过 Federation 插件实现(实验性)

## 数据流向

```
客户端连接 -> server/client.go -> hooks 钩子
                                    ↓
                    ← persistence 持久化 ← plugin 插件处理
                    ↓
            消息路由(Trie树匹配)
                    ↓
            订阅者 -> 消息投递
```

## 关键文件

- `server/server.go`: 服务器核心实现
- `server/hooks.go`: Hook 系统定义
- `pkg/packets/`: MQTT 协议实现
- `persistence/subscription/mem/topic_trie.go`: Topic 匹配 Trie 树
- `cmd/gmqttd/default_config.yml`: 默认配置示例