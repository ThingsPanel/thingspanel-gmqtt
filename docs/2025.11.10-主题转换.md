## 主题转换设计（ThingsPanel-GMQTT）

本文定义设备与平台之间的主题规范、可扩展的“自定义主题”映射规则，以及在 GMQTT 钩子中如何进行校验与转发。目标：既保证平台内置主题的一致性，又允许不同厂商/协议的设备通过配置完成无侵入接入。

### 核心概念
- **数据方向**：
  - 上行：设备 → 平台
  - 下行：平台 → 设备
- **原始主题**：设备实际发布/订阅的真实主题（可包含占位符）
- **目标主题**：平台规范化后的主题（ThingsPanel 侧统一语义）
- **占位符**：
  - MQTT 通配符：`+`（单层），不支持 `#`（多层）
  - 变量：`{device_number}`、`{message_id}` 等

---

### 建表 SQL（PostgreSQL，无触发器）

```sql
-- 主题映射表（设备配置级）
CREATE TABLE IF NOT EXISTS device_topic_mappings (
  id                BIGSERIAL PRIMARY KEY,
  device_config_id  UUID        NOT NULL,              -- 关联设备配置
  name              VARCHAR(500) NOT NULL,             -- 规则名称
   direction         VARCHAR(50) NOT NULL,              -- 上行/下行（字符串：'up' 或 'down'）
  source_topic      VARCHAR(500) NOT NULL,             -- 原始主题（支持 +、{device_number}、{message_id}）
  target_topic      VARCHAR(500) NOT NULL,             -- 目标主题（平台规范主题，来自枚举）
  priority          INT         NOT NULL DEFAULT 100,  -- 匹配优先级，越小越先匹配
  enabled           BOOLEAN     NOT NULL DEFAULT TRUE, -- 是否启用
   description       TEXT        NULL,
  created_at        TIMESTAMPTZ(6) NOT NULL DEFAULT now(),
  updated_at        TIMESTAMPTZ(6) NOT NULL DEFAULT now()
);

-- 防重复（同一设备配置、同一方向、同一源与目标主题唯一）
CREATE UNIQUE INDEX IF NOT EXISTS ux_device_topic_mapping_unique
ON device_topic_mappings (device_config_id, direction, source_topic, target_topic);

-- 按设备配置与方向查询（用于缓存预热/查找）
CREATE INDEX IF NOT EXISTS idx_device_topic_mapping_lookup
ON device_topic_mappings (device_config_id, direction, enabled, priority);
```

---

## 二、匹配与占位规则

### 上行原始主题
- 定义：设备实际发布主题，支持 `+` 占位，不支持 `#`。可选 `{message_id}` 变量。
- 示例：设备发布 `h26js234j4n23j2/up/2536548`，配置原始主题为 `+/up/+`，映射目标主题为 `devices/telemetry`。

### 下行原始 vs 目标主题
- 定义：
  - **目标主题**（平台规范主题）：平台内部统一使用、供业务逻辑发布的主题，例如 `devices/telemetry/control/{device_number}`。GMQTT 钩子总是先从规范主题解析 `{device_number}`。
  - **原始主题**：设备实际订阅的主题（可包含占位符），例如 `wled/{device_number}`。转发逻辑会把规范主题中的变量替换成实际值后，再渲染出该原始主题，把消息额外转发给设备。
- 约束：原始主题必须包含 `{device_number}`；当目标主题末尾含 `+` 时，原始主题可对应带 `+`（表示消息 ID 或请求 ID）。
- 示例：平台向规范主题 `devices/telemetry/control/db115aca-d94c-bdc1-2f2c-a98a7c297845` 发布消息。若配置映射 `wled/{device_number}` → `devices/telemetry/control/{device_number}`，则钩子会渲染原始主题 `wled/db115aca-d94c-bdc1-2f2c-a98a7c297845` 并额外转发给设备。

匹配约束：
- `+` 仅匹配单层，不匹配空/`#`
- `{device_number}`、`{message_id}` 必须被实际值替换后再对比

---

## 三、主题转换流程（Webhook/Hooks）

### 1）上行（设备 → 平台）
前提：鉴权通过，`username` 非 `root/plugin`，且设备 ID 可解析。

流程：
1. 先进行发布主题白名单校验（平台内置规范，见 `plugin/thingspanel/util/check_pub_topic.go`）。
2. 若主题不在内置白名单内，则查询该设备关联的“上行自定义主题”列表，逐条尝试匹配：
   - 若匹配成功：使用内置 MQTT 客户端将消息“额外”转发到“目标主题”（规范主题）。
3. 对于平台内部需要的消息体格式，可在收到消息时进行“重写包装”（如追加 `device_id` 等），再转发。

注意：GMQTT 钩子中无法直接修改原消息的主题，因此采用“拦截并丢弃/额外转发”的方式实现重写（实现上使用 `DefaultMqttClient` 重新发布到目标主题）。

### 2）下行（平台 → 设备）
前提：`root` 用户或平台自身业务逻辑发布到“规范化下行主题”。

流程：
1. 当平台发布的主题与系统“规范主题”匹配（如 `devices/telemetry/control/{device_number}`），提取 `{device_number}`。
2. 查询该设备关联的“下行自定义主题”配置中，是否存在相同“语义目标”的映射：
   - 若存在：除规范主题外，额外转发一份到“原始主题”（设备真实订阅的主题），必要时附带 `request_id`/`message_id`。
3. 对于设备订阅非平台规范主题的情况：若该主题命中设备“自定义下行原始主题”，则允许订阅。

实现要点：
- 主题与设备号的提取、路由与转发由插件内置客户端完成。
- 如果需要生成 `request_id`，确保幂等或可追踪。

---

## 四、平台规范主题（对照表）

### 上行
| 主题 | 说明 |
|:-|:-|
| devices/telemetry | 上报遥测 |
| devices/attributes/{message_id} | 上报属性 |
| devices/event/{message_id} | 上报事件 |
| ota/devices/progress | 上报 OTA 升级进度 |
| gateway/telemetry | 网关遥测 |
| gateway/attributes/{message_id} | 网关属性 |
| gateway/event/{message_id} | 网关事件 |
| devices/command/response/{message_id} | 命令响应上报 |
| devices/attributes/set/response/{message_id} | 属性设置响应上报 |
| gateway/command/response/{message_id} | 网关命令响应上报 |
| gateway/attributes/set/response/{message_id} | 网关属性设置响应上报 |

### 下行
| 主题 | 说明 |
|:-|:-|
| devices/telemetry/control/{device_number} | 平台下发控制 |
| devices/attributes/set/{device_number}/+ | 平台下发属性设置 |
| devices/attributes/get/{device_number} | 平台请求属性 |
| devices/command/{device_number}/+ | 平台下发命令 |
| ota/devices/inform/{device_number} | 下发升级任务 |
| gateway/telemetry/control/{device_number} | 平台下发控制（网关） |
| gateway/attributes/set/{device_number}/+ | 平台下发属性设置（网关） |
| gateway/attributes/get/{device_number} | 平台请求属性（网关） |
| gateway/command/{device_number}/+ | 平台下发命令（网关） |
| devices/attributes/response/{device_number}/+ | 平台收到属性响应 |
| devices/event/response/{device_number}/+ | 平台收到事件响应 |
| gateway/attributes/response/{device_number}/+ | 平台收到属性响应（网关） |
| gateway/event/response/{device_number}/+ | 平台收到事件响应（网关） |

---

## 五、缓存设计
- Key 约定：
  - 上行规则：`tp:topicmap:up:{device_config_id}`
  - 下行规则：`tp:topicmap:down:{device_config_id}`
  - 可选反向索引（下行按规范→原始）：`tp:topicmap:downrev:{device_config_id}`
- Value：JSON 数组，已按 `priority` 升序，仅包含启用规则：

```json
[
  {
    "id": 123,
    "source_topic": "{device_number}/down/+",
    "target_topic": "devices/command/{device_number}/+",
    "priority": 10
  }
]
```

- 读取流程：
  0) 若设备无 `device_config_id`：跳过映射查找；上行仅走发布白名单校验，下行仅走规范主题；
  1) 钩子读 Redis；命中则按优先级匹配；
  2) 未命中则查 PG → 构建规则列表 → 写入缓存 → 再匹配。
- 失效策略：
  - 新增/更新/删除/启停某“设备配置映射”后，删除该 `device_config_id` 的相关 Key（`up`/`down`/`downrev`）。
  - TTL 建议不设或设置较长兜底，主要依赖显式失效。
- 作用：降低钩子内数据库访问与匹配开销。

---

## 六、实现与代码位置（当前状况）

- 发布/订阅白名单与匹配：
  - 上行发布白名单：`plugin/thingspanel/util/check_pub_topic.go`
  - 下行订阅白名单：`plugin/thingspanel/util/check_sub_topic.go`
- GMQTT 钩子与转发：
  - Hook 注册：`plugin/thingspanel/hooks.go`（`HookWrapper`）
  - 发布校验与消息包装：`OnMsgArrivedWrapper`（当前已做发布白名单校验与 payload 包装）
  - 下行 root 转发工具：`plugin/thingspanel/other.go` 的 `RootMessageForwardWrapper`（可用作下行额外转发）
  - MQTT 客户端：`plugin/thingspanel/mqtt.go` 的 `DefaultMqttClient`
- 设备/缓存访问：
  - Redis/PG 初始化与工具：`plugin/thingspanel/db.go`

注意（与目标设计的差异）：
- 目前“上行主题不在白名单时，按自定义映射转发”的逻辑尚未接入钩子，需要补充：在 `OnMsgArrivedWrapper` 未通过白名单时，查配置并使用 `DefaultMqttClient` 转发到“目标主题”，同时决定是否丢弃原消息。
- 下行“规范主题 → 设备自定义原始主题”的额外转发逻辑可复用 `RootMessageForwardWrapper` 思路，但尚需与“自定义映射”打通。
- 钩子内无法直接改写主题，只能“拦截+重新发布”。

---

## 七、示例

### 上行（厂商自定义 → 平台规范）
- 原始：`mindjoy/{token}/up/{msgId}`
- 目标：`devices/telemetry`
- 规则：`mindjoy/+/up/+` → `devices/telemetry`
- 行为：命中后，插件将消息包装为 `{"device_id": "...","values": <payload>}` 并转发到 `devices/telemetry`。

### 下行（平台规范 → 设备自定义）
- 规范：`devices/attributes/set/{device_number}/{message_id}`
- 原始：`mindjoy/devices/{token}/sys/properties/set/request_id={message_id}`
- 行为：平台对规范主题发布后，插件根据 `{device_number}` 找到映射并额外转发到原始主题（保留/生成 `{message_id}`）。

---

## 八、注意事项
- 严格限制通配：允许 `+`，不允许 `#`。
- 对于带 `{message_id}` 的通道，需处理好请求-响应关联与幂等。
- 建议将“主题转换逻辑 + 缓存”封装到独立文件以便维护与测试。

---

## 九、设计合理性与建议
该设计兼顾了平台统一语义与设备厂商差异化接入，合理可行。建议：
- 明确白名单与自定义映射的优先级与互斥关系；
- 将“未命中白名单 → 尝试自定义映射 → 转发/丢弃”的流程固化在钩子；
- 封装自定义映射的查询与匹配（带缓存）；补齐下行额外转发；
- 增加单元测试覆盖常见映射与边界匹配（`+` 与变量混用）。